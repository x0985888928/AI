name: CI and CD Pipeline

# è¨­å®šè§¸ç™¼æ¢ä»¶ï¼špush åˆ° main æˆ– pull request æŒ‡å‘ main æ™‚éƒ½æœƒè§¸ç™¼æ•´å€‹ workflow
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # ğŸ” CI æª¢æŸ¥æµç¨‹ï¼Œåªåœ¨ pull request æ™‚åŸ·è¡Œï¼ˆåˆ¤æ–· github.event_nameï¼‰
  ci-check:
    name: ğŸ§ª CI - Build and Test
    runs-on: ubuntu-latest

    # åªæœ‰åœ¨äº‹ä»¶æ˜¯ PR æ™‚æ‰åŸ·è¡Œé€™å€‹ job
    if: github.event_name == 'pull_request'

    steps:
      # ğŸ”¹ ä¸‹è¼‰ PR çš„åŸå§‹ç¢¼
      - name: Checkout code
        uses: actions/checkout@v3

      # ğŸ”¹ å®‰è£ .NET 8 SDK
      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 8.0.x

      # ğŸ”¹ å˜—è©¦ç·¨è­¯å°ˆæ¡ˆ
      - name: Build solution
        run: dotnet build ./ML.NET/ML.NET/ML.NET.csproj --configuration Release

      # ğŸ”¹ åŸ·è¡Œå–®å…ƒæ¸¬è©¦ï¼ˆå¦‚æœæ²’æœ‰æ¸¬è©¦ä¹Ÿä¸æœƒå¤±æ•—ï¼‰
      - name: Run tests (if any)
        run: dotnet test ./ML.NET/ML.NET/ML.NET.csproj || true

  # CD éƒ¨ç½²æµç¨‹ï¼Œåªåœ¨ push åˆ° main æ™‚åŸ·è¡Œ
  cd-deploy:
    name: CD - Package for Deployment
    runs-on: ubuntu-latest

    # åªæœ‰åœ¨äº‹ä»¶æ˜¯ push æ™‚æ‰åŸ·è¡Œé€™å€‹ job
    if: github.event_name == 'push'

    steps:
      # ğŸ”¹ ä¸‹è¼‰æœ€æ–°çš„ main åŸå§‹ç¢¼
      - name: Checkout code
        uses: actions/checkout@v3

      # ğŸ”¹ å®‰è£ .NET 8 SDK
      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 8.0.x

      # ğŸ”¹ ä½¿ç”¨ dotnet publish æŒ‡ä»¤æ‰“åŒ…ï¼ˆè¼¸å‡ºåˆ° output è³‡æ–™å¤¾ï¼‰
      - name: Publish project
        run: dotnet publish ./ML.NET/ML.NET/ML.NET.csproj -c Release -o output

      # ğŸ”¹ æŠŠ output è³‡æ–™å¤¾å£“ç¸®æˆ output.zip
      - name: Zip output
        run: zip -r output.zip output

      # ğŸ”¹ ä¸Šå‚³ ZIP æˆæœåˆ° GitHub Actions çš„ Artifactï¼ˆä½ å¯ä»¥åœ¨ Actions é é¢ä¸‹è¼‰ï¼‰
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ML.NET-Publish-ZIP
          path: output.zip
